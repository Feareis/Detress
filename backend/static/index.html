<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Detress - Dashboard</title>
  <style>
    :root {
      --bg-main: #0f172a;
      --bg-card: #020617;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #94a3b8;
      --accent-ok: #22c55e;
      --accent-warn: #facc15;
      --accent-err: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      padding: 0;
    }

    header {
      padding: 16px 24px;
      background: #020617;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent-err);
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.8);
    }

    .status-dot.healthy {
      background: var(--accent-ok);
    }

    .status-dot.degraded {
      background: var(--accent-warn);
    }

    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 16px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .card h2 {
      margin: 0;
      font-size: 16px;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h2 span.sub {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: normal;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--border-subtle);
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:nth-child(odd) {
      background: #020617;
    }

    .level-high {
      color: var(--accent-err);
      font-weight: 600;
    }

    .level-medium {
      color: var(--accent-warn);
      font-weight: 600;
    }

    .level-low {
      color: var(--accent-ok);
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid var(--border-subtle);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .footer {
      padding: 8px 16px;
      font-size: 11px;
      color: var(--text-soft);
      border-top: 1px solid var(--border-subtle);
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .scroll {
      max-height: 400px;
      overflow: auto;
    }

    .error-banner {
      display: none;
      background: rgba(248, 113, 113, 0.12);
      color: var(--accent-err);
      border-bottom: 1px solid rgba(248, 113, 113, 0.4);
      padding: 8px 16px;
      font-size: 12px;
    }

    .error-banner.visible {
      display: block;
    }

    .muted {
      color: var(--text-muted);
    }

    .empty-state {
      padding: 8px 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Detress – Dashboard</h1>
    <div class="status-indicator small">
      <span class="status-dot" id="status-dot"></span>
      <span>Backend: <span id="health-status">checking...</span></span>
    </div>
  </header>

  <div id="error-banner" class="error-banner">
    Backend request failed. Check API status or network connectivity.
  </div>

  <div class="container">
    <!-- TRAFFIC -->
    <div class="card">
      <h2>
        Live Traffic
        <span class="sub">last 100 events</span>
      </h2>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Src IP</th>
              <th>Dst IP</th>
              <th>Src Port</th>
              <th>Dst Port</th>
              <th>Proto</th>
              <th>Size</th>
            </tr>
          </thead>
          <tbody id="traffic-body">
          </tbody>
        </table>
        <div id="traffic-empty" class="empty-state muted" style="display:none;">
          No traffic events yet. Once the capture agent is running, data will appear here.
        </div>
      </div>
    </div>

    <!-- ALERTS -->
    <div class="card">
      <h2>
        Alerts
        <span class="sub">last 50 alerts</span>
      </h2>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Level</th>
              <th>Category</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="alerts-body">
          </tbody>
        </table>
        <div id="alerts-empty" class="empty-state muted" style="display:none;">
          No alerts generated yet. Detection rules will appear here when triggered.
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <span>Auto-refresh: every 2 seconds</span>
    <span id="last-refresh" class="small"></span>
  </div>

  <script>
    "use strict";

    const API_BASE = window.location.origin;
    const REFRESH_INTERVAL_MS = 2000;

    const statusDot = document.getElementById("status-dot");
    const healthStatusEl = document.getElementById("health-status");
    const errorBanner = document.getElementById("error-banner");

    const trafficBody = document.getElementById("traffic-body");
    const alertsBody = document.getElementById("alerts-body");
    const trafficEmpty = document.getElementById("traffic-empty");
    const alertsEmpty = document.getElementById("alerts-empty");
    const lastRefreshEl = document.getElementById("last-refresh");

    /**
     * Perform a JSON fetch with basic error handling.
     * This function is generic and used by both traffic and alert polling.
     */
    async function fetchJSON(url) {
      const res = await fetch(url, { cache: "no-cache" });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} for ${url}`);
      }
      return res.json();
    }

    /**
     * Format time values consistently for display.
     * Supports:
     *   - float UNIX timestamp (seconds since epoch)
     *   - ISO 8601 string
     */
    function formatTime(ts) {
      if (!ts) return "";

      // Backend traffic timestamp is a Unix float (seconds)
      if (typeof ts === "number") {
        const d = new Date(ts * 1000);
        return d.toLocaleTimeString();
      }

      // Backend alert timestamp is ISO (datetime)
      const d = new Date(ts);
      return d.toLocaleTimeString();
    }

    /**
     * Render the traffic table body from an array of events.
     */
    function renderTraffic(data) {
      trafficBody.innerHTML = "";

      if (!data || data.length === 0) {
        trafficEmpty.style.display = "block";
        return;
      }

      trafficEmpty.style.display = "none";

      data.forEach(evt => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${formatTime(evt.timestamp)}</td>
          <td>${evt.src_ip || ""}</td>
          <td>${evt.dst_ip || ""}</td>
          <td>${evt.src_port ?? ""}</td>
          <td>${evt.dst_port ?? ""}</td>
          <td>${evt.protocol || ""}</td>
          <td>${evt.size ?? ""}</td>
        `;

        trafficBody.appendChild(tr);
      });
    }

    /**
     * Render the alerts table body from an array of alert objects.
     */
    function renderAlerts(data) {
      alertsBody.innerHTML = "";

      if (!data || data.length === 0) {
        alertsEmpty.style.display = "block";
        return;
      }

      alertsEmpty.style.display = "none";

      data.forEach(alert => {
        const tr = document.createElement("tr");

        const level = alert.level || "";
        const levelClass =
          level.toLowerCase() === "high" ? "level-high" :
          level.toLowerCase() === "medium" ? "level-medium" :
          "level-low";

        tr.innerHTML = `
          <td>${formatTime(alert.timestamp)}</td>
          <td class="${levelClass}">
            <span class="badge">${level}</span>
          </td>
          <td>${alert.category || ""}</td>
          <td>${alert.message || ""}</td>
        `;

        alertsBody.appendChild(tr);
      });
    }

    /**
     * Update backend health status and visual indicator.
     */
    async function updateHealth() {
      try {
        const data = await fetchJSON(API_BASE + "/health");
        const healthy = data && data.status === "ok";

        healthStatusEl.textContent = healthy ? "ok" : (data.status || "unknown");
        statusDot.classList.toggle("healthy", healthy);
        statusDot.classList.toggle("degraded", !healthy);
      } catch (e) {
        console.error("health check error:", e);
        healthStatusEl.textContent = "down";
        statusDot.classList.remove("healthy");
        statusDot.classList.add("degraded");
      }
    }

    /**
     * Refresh traffic + alerts panels.
     * Errors are logged and reflected in a user-visible banner.
     */
    async function refreshAll() {
      try {
        const [traffic, alerts] = await Promise.all([
          fetchJSON(API_BASE + "/traffic?limit=100"),
          fetchJSON(API_BASE + "/alerts?limit=50"),
        ]);

        renderTraffic(traffic);
        renderAlerts(alerts);

        errorBanner.classList.remove("visible");

        const now = new Date();
        lastRefreshEl.textContent =
          "Dernière mise à jour : " + now.toLocaleTimeString();
      } catch (e) {
        console.error("refresh error:", e);
        errorBanner.classList.add("visible");
      }
    }

    /**
     * Initialize dashboard: health check + first refresh + periodic updates.
     */
    async function init() {
      await updateHealth();
      await refreshAll();

      // Periodic refresh loop
      setInterval(refreshAll, REFRESH_INTERVAL_MS);
    }

    init();
  </script>
</body>
</html>
